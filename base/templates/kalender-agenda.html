{% extends 'base/base.html' %}

{% load static %}

{% block title %}Kalender Agenda{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'calendar/fonts/icomoon/style.css' %}">
    
    <link href="{% static 'calendar/fullcalendar/packages/core/main.css' %}" rel='stylesheet' />
    <link href="{% static 'calendar/fullcalendar/packages/daygrid/main.css' %}" rel='stylesheet' />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'calendar/css/bootstrap.min.css' %}">

    <!-- Style -->
    <link rel="stylesheet" href="{% static 'calendar/css/style.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-2 text-gray-800">Kalender Agenda</h1>
    <p class="mb-4">Kalender Agenda adalah data Perangkat Desa yang terdaftar dalam Sistem Pendataan Agenda Desa</p>

    {% if messages %}
    {% for message in messages %}
        {% if 'error' in message.tags %}
            <div class="card bg-danger text-white shadow mb-2">
                <div class="card-body">
                    {{ message }}
                </div>
            </div>
        {% elif 'success' in message.tags %}
            <div class="card bg-success text-white shadow mb-2">
                <div class="card-body">
                    {{ message }}
                </div>
            </div>
        {% endif %}
    {% endfor %}
    {% endif %}

<!-- Modal for Adding Agenda -->
<div class="modal fade" id="addAgendaModal" tabindex="-1" role="dialog" aria-labelledby="addAgendaModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAgendaModalLabel">Tambah Agenda</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'tambah-agenda' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="agendaTitle">Judul Agenda</label>
                        <input type="text" class="form-control" id="agendaTitle" name="nama_agenda" required>
                    </div>
                    <div class="form-group">
                        <label for="agendaStart">Tanggal Mulai</label>
                        <input type="datetime-local" class="form-control" id="agendaStart" name="tanggal_mulai" required>
                    </div>
                    <div class="form-group">
                        <label for="agendaEnd">Tanggal Selesai</label>
                        <input type="datetime-local" class="form-control" id="agendaEnd" name="tanggal_selesai" required>
                    </div>
                    <div class="form-group">
                        <label for="agendaPlace">Tempat</label>
                        <input type="text" class="form-control" id="agendaPlace" name="tempat" required>
                    </div>
                    <div class="form-group">
                        <label for="agendaDescription">Deskripsi</label>
                        <textarea class="form-control" id="agendaDescription" name="deskripsi" rows="3" required></textarea>
                    </div>
                    <input type="hidden" id="agendaDate" name="date">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Agenda</button>
                </div>
            </form>
        </div>
    </div>
</div>



    <div id='calendar'></div>

</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'calendar/js/jquery-3.3.1.min.js' %}"></script>
<script src="{% static 'calendar/js/popper.min.js' %}"></script>
<script src="{% static 'calendar/js/bootstrap.min.js' %}"></script>

<script src="{% static 'calendar/fullcalendar/packages/core/main.js' %}"></script>
<script src="{% static 'calendar/fullcalendar/packages/interaction/main.js' %}"></script>
<script src="{% static 'calendar/fullcalendar/packages/daygrid/main.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
    
        // Data agenda asli
        var agendaData = {{ agenda_list|safe }};

        // Mengubah data agenda menjadi format yang diperlukan FullCalendar
        var events = agendaData.map(function(item) {
            return {
                id: item.id,
                title: item.nama_agenda,
                start: item.tanggal_mulai,
                end: item.tanggal_selesai,
                description: item.deskripsi,
                location: item.tempat
            };
        });

        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: [ 'interaction', 'dayGrid' ],
            defaultDate: today,
            editable: true,
            eventLimit: true, // allow "more" link when too many events
            events: events,
            dateClick: function(info) {
                // Format the clicked date for the datetime-local input
                var dateStr = info.dateStr + "T00:00";
                
                // Set the date in the form
                document.getElementById('agendaStart').value = dateStr;
                document.getElementById('agendaEnd').value = dateStr;
    
                // Show the modal
                $('#addAgendaModal').modal('show');
            }
        });
    
        calendar.render();
    });
</script>

<script src="{% static 'calendar/js/main.js' %}"></script>
{% endblock extra_js %}